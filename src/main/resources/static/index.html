<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Todo</title>
    <style>
        body {
            margin-left: auto;
            margin-right: auto;
            width: 50%;
        }

        input.form__input {
            height: 50px;
            margin-right: 10px;
        }

        button.form__button {
            height: 55px;
        }

        small.tag {
            border-radius: 10px;
            border: 1px solid blue;
            height: 20px;
            margin-left: 10px;
        }

        small.tag:hover {
            background-color: blue;
            color: white;
            cursor: pointer;
        }

        .todo__item {
            padding: 10px;
            font-size: large;
            display: flex;
            flex-direction: row;
        }
        .todo__item div {
            margin-right: 10px;
        }
        .todo__result {
            margin-top: 30px;
        }

        ul li {
            list-style: none;
        }
        .add__tag__button {
            margin-top: 5px;
            border: 1px solid blue;
            width: 75PX;
            cursor: pointer; 
            color: blue; 
            text-align: center;
        }
        
        .add__tag__button:hover {
            border: 1px solid black;
            border-radius: 5px;
            display: block;
        }

    </style>
</head>
<body>
    <div id="app">
        <h1>{{ message }}</h1>
        <hr/>

        <div class="todo__form">
            <form @submit.prevent="submitTask">
                <input class="form__input" type="date" v-model="task.date">
                <input class="form__input" type="time" v-model="task.time">
                <input class="form__input" type="text" v-model="task.title">
                <button class="form__button" :disabled="!task.title || !task.date">Add</button>
            </form>
        </div>

        <div class="todo__result">
            <ul>
                <li v-for="x in Object.keys(taskGroup)">
                    <todos :_date=x :data=taskGroup[x] :user_tags="userTags" @add_tag_to_task="(taskId, tagId) => console.log(`${taskId}-${tagId} add_tag_to_task`)"></todos>
                </li>
            </ul>
        </div>

        <hr/>
        <footer style="text-align: right; color: gray">
            <small>@ all right reserved!</small>
        </footer>
    </div>

    <template id="group_todo">
        <p style="font-size: large; text-decoration: underline">{{ date }}</p>
        <div class="todo__item" v-for="(todo, index) in data" :key="index">
            <div>
                <input type="checkbox">
            </div>

            <div style="display: flex; flex-direction: column">
                
                <div>
                    <span>{{ todo.title }}</span>
                    <small class="tag" v-for="t in todo.tags" @click="() => alert(t.tagId)">{{ t.tagId }}</small>
                </div>
                
                <div style="margin-top: 10px;" v-if="tagControl[index]">
                    <select v-model="selectedTag">
                        <option value="">--Select Tag--</option>
                        <option :value="userTag.id" v-for="userTag in userTags">{{ userTag.name }}</option>
                    </select>
                    <input style="margin-left: 10px;" type="text" placeholder="Add New Tag">
                </div>
                
                <span class="add__tag__button" @click="handleTagController(index, todo.taskId)">{{tagControl[index] ? '#save' : '#add-tag'}}</span>
                
            </div>
        </div>
    </template>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        const { createApp, ref, toRef, onMounted , watch} = Vue
        const userId = 1;
        const apiHost = "http://localhost:8080"

        //reusable component
        const todos = {
            template: '#group_todo',
            props: ['data','_date', 'user_tags'],
            emits: ['add_new_tag', 'add_tag_to_task'],
            setup(props, { emit }) {
                const tagControl = ref({})
                const date = toRef(props, '_date')
                const data = toRef(props, 'data')
                const userTags = toRef(props, 'user_tags')
                const selectedTag = ref(null)
                const handleTagController = (index, taskId) => {
                    tagControl.value[index] = !tagControl.value[index];
                    if (!tagControl.value[index])
                        emit('add_tag_to_task', taskId, selectedTag.value)
                }
                return {
                    tagControl, handleTagController, date, data, userTags, selectedTag
                };
            }
        }

        createApp({
            setup() {
                const message = ref('Todo!')
                const task = ref({
                    date: null,
                    time: null,
                    title: '',
                })
                const tasks = ref([])
                const taskGroup = ref({})
                const userTags = ref([])
                
                const saveTask = (task) => {
                  fetch(`${apiHost}/todo/${userId}/tasks`,{
                    method: 'POST',
                    headers : {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(task)
                  })
                    .then(response => {
                        if(!response.ok)
                            throw new Error("Error While saving")
                        return response.json()
                    })
                    .then(data => allTask())
                    .catch(e => console.log(e))
                }

                const allTask = () => {
                    fetch(`${apiHost}/todo/${userId}/tasks`)
                        .then(response => {
                            if(!response.ok)
                                throw new Error("Error While fetching")
                            return response.json()
                        })
                        .then(data => tasks.value = data)
                }

                const allTags = () => {
                    fetch(`${apiHost}/todo/${userId}/tags`)
                        .then(response => {
                            if(!response.ok)
                                throw new Error("Error While fetching")
                            return response.json()
                        })
                        .then(data => userTags.value = data)
                }

                const submitTask = () => {
                    console.log(task.value)
                    saveTask(task.value)
                    task.value = {
                        date: null,
                        time: null,
                        title: '',
                    }
                }

                onMounted(() => {
                    console.log(`the component is now mounted.`)
                    allTask()
                    allTags()
                })
                
                watch(
                    () => tasks.value.length,
                    (tasksLength) => {
                        taskGroup.value = Object.groupBy(tasks.value, ({date}) => date)
                    }
                )
                
                return {
                    message, task, submitTask, tasks, taskGroup, userTags
                }
            },
            components: {todos}
        }).mount('#app')

    </script>
</body>
</html>